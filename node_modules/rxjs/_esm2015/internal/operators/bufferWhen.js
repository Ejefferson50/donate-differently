import { Subscription } from '../Subscription';
<<<<<<< HEAD
import { SimpleOuterSubscriber, innerSubscribe, SimpleInnerSubscriber } from '../innerSubscribe';
=======
import { OuterSubscriber } from '../OuterSubscriber';
import { subscribeToResult } from '../util/subscribeToResult';
>>>>>>> 782567c486993431d88a7d42ed2c18702ecdfd4f
export function bufferWhen(closingSelector) {
    return function (source) {
        return source.lift(new BufferWhenOperator(closingSelector));
    };
}
class BufferWhenOperator {
    constructor(closingSelector) {
        this.closingSelector = closingSelector;
    }
    call(subscriber, source) {
        return source.subscribe(new BufferWhenSubscriber(subscriber, this.closingSelector));
    }
}
<<<<<<< HEAD
class BufferWhenSubscriber extends SimpleOuterSubscriber {
=======
class BufferWhenSubscriber extends OuterSubscriber {
>>>>>>> 782567c486993431d88a7d42ed2c18702ecdfd4f
    constructor(destination, closingSelector) {
        super(destination);
        this.closingSelector = closingSelector;
        this.subscribing = false;
        this.openBuffer();
    }
    _next(value) {
        this.buffer.push(value);
    }
    _complete() {
        const buffer = this.buffer;
        if (buffer) {
            this.destination.next(buffer);
        }
        super._complete();
    }
    _unsubscribe() {
<<<<<<< HEAD
        this.buffer = undefined;
        this.subscribing = false;
    }
    notifyNext() {
=======
        this.buffer = null;
        this.subscribing = false;
    }
    notifyNext(outerValue, innerValue, outerIndex, innerIndex, innerSub) {
>>>>>>> 782567c486993431d88a7d42ed2c18702ecdfd4f
        this.openBuffer();
    }
    notifyComplete() {
        if (this.subscribing) {
            this.complete();
        }
        else {
            this.openBuffer();
        }
    }
    openBuffer() {
        let { closingSubscription } = this;
        if (closingSubscription) {
            this.remove(closingSubscription);
            closingSubscription.unsubscribe();
        }
        const buffer = this.buffer;
        if (this.buffer) {
            this.destination.next(buffer);
        }
        this.buffer = [];
        let closingNotifier;
        try {
            const { closingSelector } = this;
            closingNotifier = closingSelector();
        }
        catch (err) {
            return this.error(err);
        }
        closingSubscription = new Subscription();
        this.closingSubscription = closingSubscription;
        this.add(closingSubscription);
        this.subscribing = true;
<<<<<<< HEAD
        closingSubscription.add(innerSubscribe(closingNotifier, new SimpleInnerSubscriber(this)));
=======
        closingSubscription.add(subscribeToResult(this, closingNotifier));
>>>>>>> 782567c486993431d88a7d42ed2c18702ecdfd4f
        this.subscribing = false;
    }
}
//# sourceMappingURL=bufferWhen.js.map